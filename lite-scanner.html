<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="./qr-scanner-mixin.html">


<!-- <script defer type="text/javascript" src="./lib/instascan.min.js"></script> -->
<!-- <link defer rel="import" href="./qr-scanner-lib.html"> -->

<dom-module id="lite-scanner">
  <template>
    <style>
      :host {
        display: block;
        padding: 0;
      }

      video {
        /* transform: scale(0.5); */
        width: 100%;
        border-radius: 10px; 
      }
    </style>

    <video id="video" autoplay></video>
  </template>
  <script>
    /**
     * `lite-scanner`
     * lightweight qr-code scanner web component 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

    class LiteScanner extends Mixins.QrScannerMixin(Polymer.Element) {
      static get is() { return 'lite-scanner'; }
      static get properties() {
        return {
          data: {
            type: Object,
            notify: true, 
            reflectToAttribute: true,
            computed: '_formatContent(content)'
          },
          content: {
            type: String,
            notify: true,
            value: ''
          },
          opts: {
            type: Object,
            notify: true,
            computed: '_createConfig()'
          },
          type: {
            type: String,
            notify: true,
            value: 'string'
          },
          oneRead: {
            type: Boolean,
            notify: true,
            reflectToAttribute: true,
            value: true
          },
          state: {
            type: Boolean,
            notify: true,
            reflectToAttribute: true
          }
        }
      }

      /**
       * Use for one-time configuration of your component after local DOM is
       * initialized.
       */
      ready() {
        super.ready();
        Polymer.RenderStatus.afterNextRender(this, () => {
          this.scanner = this.QrScanner;
        });
      }

      /**
        * Array of strings describing multi-property observer methods and their
        * dependant properties
        */
      static get observers() {
        return [
          // '_scannerChanged(scanner)',
          "_stateChanged(scanner._active)"
        ];
      }

      _stateChanged(scannerState) {
        if(scannerState === undefined) return;
        this.state = !!scannerState;
      }

      _scannerChanged(scanner) {
        if (!scanner) return;
        
        this.scanner.addListener('scan', (content) => {
          this.content = content;
          if (this.oneRead) this.stop();
        });

        this.scanner.addListener('active', (content) => {
          this.state = true;
        });

        this.scanner.addListener('inactive', (content) => {
          this.state = false;
        });
      }

      _readResult(result) {
        if(!result) return false;
        this.content = result;
        if (this.oneRead) this.stop();
        return true;
      }

      _createConfig() {
        return { 
            // backgroundScan: false, 
            // video:true,
            // scanPeriod: 10,
            // mirror: false
            video: { facingMode: "user" }
          }
      }

      _formatContent(content) {
        
        if(!content) {
         switch (this.type) {
           case 'json':
            return {};
            break;
           case 'string':
            return '';
            break;
           default:
             break;
         }
        }
        console.log(content);

        let readData = null;
        switch (this.type) {
          case 'json':
            readData = JSON.parse(content);
            break;
          case 'string': 
            readData = content;
            break;
          default:
            break;
        }

        if (readData) {
          setTimeout(() => {this.set('content', '');}, 500);
          return readData;
        } else {
          return {};
        }
      }

      toggleReadMode() {
        this.set('oneRead', !this.oneRead);
      }

      config(opts) {
        this.opts = Object.assign(this.opts, opts);
        this.set('opts', opts);
      }

      init() {
        // this.opts.videoEl = this.shadowRoot.getElementById('video');
        this.QrScanner.getVideoInputDevices()
        //     .then((videoInputDevices) => {
        //       // const sourceSelect = document.getElementById('sourceSelect')
        //       // selectedDeviceId = videoInputDevices[0].deviceId
        //       if (videoInputDevices.length >= 1) {
        //         videoInputDevices.forEach((element) => {
        //           const sourceOption = document.createElement('option')
        //           sourceOption.text = element.label
        //           sourceOption.value = element.deviceId
        //           sourceSelect.appendChild(sourceOption)
        //         })
        //       } else {
        //         selectedDeviceId = videoInputDevices[0].deviceId
        //       }
        //     }
        this.QrScanner.getMediaElement = () => { }


        this.set('scanner', this.QrScanner);
      }

      // _getCameras() {
      //   const cam = navigator.mediaDevices.getUserMedia(this.opts);
      //   cam.then((cameras) => {
      //     if (cameras.length > 0) {
      //       let selectedCam = cameras[cameras.length-1];
      //       return selectedCam
      //     } else {
      //       console.error('No cameras found.');
      //     }
      //   }, this).catch(function (e) {
      //     console.error(e);
      //   });
      // }
      

      start() {
        if (!this.scanner) {
          console.log('Config and init first.');
          this.init();
        }

        // this.scanner.start();
        this.scanner.decodeFromInputVideoDevice(undefined, this.$.video).then( (content) => {
          this.content = content.text;
          if (this.oneRead) this.stop();
        }).catch( (err) => {
          console.error(err);
          this.scanner.reset();
        });
        this.state = true;

        // const selectedCam = this._getCameras();
        

        // Instascan.Camera.getCameras().then((cameras) => {
        //   if (cameras.length > 0) {
        //     var selectedCam = cameras[cameras.length-1];
        //     this.scanner.start(selectedCam);
        //   } else {
        //     console.error('No cameras found.');
        //   }
        // }, this).catch(function (e) {
        //   console.error(e);
        // });
        // const videoElem = this.shadowRoot.querySelector('video');
        // this.qrScanner = new QrScanner(videoElem, result => console.log('decoded qr code:', result));
      }

      stop() {
        if (this.scanner) this.scanner.reset();
        this.state = false;
      }
    }
    window.customElements.define(LiteScanner.is, LiteScanner);
    </script>
</dom-module>
