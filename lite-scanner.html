<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="./qr-scanner-lib.html">

<dom-module id="lite-scanner">
  <template>
    <style>
      :host {
        display: block;
        padding: 0;
      }

      video {
        /* transform: scale(0.5); */
        width: 100%;
        border-radius: 10px; 
      }
    </style>

    <video id="preview"></video>
  </template>

  <script>
    /**
     * `lite-scanner`
     * lightweight qr-code scanner web component 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

    class LiteScanner extends Polymer.Element {
      static get is() { return 'lite-scanner'; }
      static get properties() {
        return {
          data: {
            type: Object,
            notify: true, 
            reflectToAttribute: true,
            computed: '_formatContent(content)'
          },
          content: {
            type: String,
            notify: true,
            value: ''
          },
          opts: {
            type: Object,
            notify: true,
            computed: '_createConfig()'
          },
          type: {
            type: String,
            notify: true,
            value: 'json'
          },
          oneRead: {
            type: Boolean,
            notify: true,
            reflectToAttribute: true,
            value: true
          },
          state: {
            type: Boolean,
            notify: true,
            reflectToAttribute: true
          }
        }
      }

      /**
        * Array of strings describing multi-property observer methods and their
        * dependant properties
        */
      static get observers() {
        return [
          '_scannerChanged(scanner)'
        ];
      }

      _scannerChanged(scanner) {
        if (!scanner) return;
        
        this.scanner.addListener('scan', (content) => {
          this.content = content;
          if (this.oneRead) this.stop();
        });

        this.scanner.addListener('active', (content) => {
          this.state = true;
        });

        this.scanner.addListener('inactive', (content) => {
          this.state = false;
        });
      }

      _createConfig() {
        return { 
            backgroundScan: false, 
            scanPeriod: 10,
            mirror: false
          }
      }

      _formatContent(content) {
        
        if(!content) return {};
        console.log(content);

        const readData = JSON.parse(content);
        if (readData) {
          setTimeout(() => {this.set('content', '');}, 500);
          return readData;
        } else {
          return {};
        }
      }

      toggleReadMode() {
        this.set('oneRead', !this.oneRead);
      }

      config(opts) {
        this.opts = Object.assign(this.opts, opts);
        this.set('opts', opts);
      }

      init() {
        this.opts.video = this.shadowRoot.getElementById('preview');
        let scanner = new Instascan.Scanner(this.opts);
        this.set('scanner', scanner);
      }
      

      start() {
        if (!this.scanner) {
          console.error('Config and init first.');
          this.init();
        }

        Instascan.Camera.getCameras().then((cameras) => {
          if (cameras.length > 0) {
            var selectedCam = cameras[cameras.length-1];
            this.scanner.start(selectedCam);
          } else {
            console.error('No cameras found.');
          }
        }, this).catch(function (e) {
          console.error(e);
        });
        // const videoElem = this.shadowRoot.querySelector('video');
        // this.qrScanner = new QrScanner(videoElem, result => console.log('decoded qr code:', result));
      }

      stop() {
        if (this.scanner) this.scanner.stop();
      }
    }
    window.customElements.define(LiteScanner.is, LiteScanner);
  </script>
</dom-module>
